# QPP-CPAC
# This document is adapted from Shella Keilholz, D et al.

DetectQPPvNov18 detects a dominant spatio-temporal pattern that might recur throughout imaged timeseries - referred to as a Quasi Periodic Pattern or QPP, see QPPalgorithm.docx, Yousefi et al., NeuroImage 2018, and Majeed et al., NeuroImage 2011.

1) QPPv0418 is the main matlab function and its inputs are:
B: Imaged timeseries, which in version Nov18, should be HCP-style, i.e., a 2D array of nX by nT with rows being spatial dimension and columns being temporal dimension. Also, in version Nov18, all runs of all subjects should be concatenated, hence the output would be the group QPP; all runs should have the same number of timepoints and norm z-scored before concatenation.
Note - QPP can be detected in individual-level but for most further analyses, such as averaging the templates of individuals or comparing the templates between individuals, each QPP of each individual should be phase-adjusted, for instance, QPP timecourse at a reference parcel first rises towards its maximum then falls towards its minimum. Group QPP has less variability in phase, hence, for most further analyses, such as comparison of the templates between two groups, only fine phase-matching suffices (TCMPwFPHM function compares two templates using fine-matching).
nd: Total number of scans concatenated across all subjects and all runs
msk: Spatial mask of nX by 1 where to-be-included should be set to 1 and to-be-excluded zeroed.
WL: QPP duration in terms of timepoints.  An estimate for WL in humans is ~20s (~30 timepoint with TR=0.72s) and in rats is ~4s (8 timepoint with TR=0.5s). With WL set to 20s in humans, QPP involves ~1 cycle of activation and deactivation of the major large-scale networks such as default-mode or task-positive.
nRP: Number of random initial segments to inspect (see QPPalgorithm.docx). For start, set nRP equal to the total number of scans or nd; increase to two or three fold if the outputted QPP correlation timecourse doesn’t look quasi-periodic. In Yousefi et al., 2018, for a rigorous assessment, all the segments were inspected, however, in group-level, a few randomly selected, suffices in most cases.
cth: Correlation threshold (see QPPalgorithm.docx) for early and late iterations, set to [0.2 0.3] or lower to [0.1 0.2].
n_iter_th1: Number of early iterations with the lower correlation threshold, set to 1 to 3.
mx_iter: maximum number of iterations, set to 15 or 20
pf2s: path and file-name of the .mat file to save correlation timecourse (C) and supra-threshold local maxima of C (FTP stands for final seed timepoints) corresponding to each template that results from inspecting each initial segment. The saved .mat file is the output of QPPv0418. Recall each template is the average of segments of scan with length WL starting at certain FTPs.

2) BSTT reads the output.mat file generated by QPPv0418 and chooses the best template (T1 or QPP) which is the one with maximum sum of its correlation at supra-threshold local maxima (see Yousefi et al. 2018) and outputs: correlation of this best template (C1), supra-threshold local maxima of C1 (FTP1), and 3 summary metrics (median of C1 at FTP1, median of ΔFTP1, number of FTP1).

3) TBLD2WL builds the best template (T1) by averaging segments of the imaged timeseries (B) starting at FTP1-WL/2 to FTP1+WL+WL/2: extra half window-length is mostly to have die-off effects at each end for visualization. It would also be used for fine-phase-matching two templates when comparing them, other words to have the ability to shift one of the two templates a few timepoints forwards or backwards.

4) Plots - Correlation timecourse of the best template (C1 for T1) and its summary metrics verifies the existence, strength and the periodicity of a quasi-periodic pattern in the imaged timeseries. Visualization of QPP is data-specific. Data1.mat and Data2.mat are examples of fMRI timeseries with spatial dimension reduced to Glasser’s 360 cortical parcels: one can easily re-order the parcels according to Yeo’s 7 networks to check the expected positive and negative correlations between and within those networks; QPP timecourses can be plotted per each parcel, or grouped based on 22 Glasser’s anatomical regions; QPP in voxel-space can be built by averaging segments in voxel-space starting at FTP1 and visualized by, for instance, HCP workbench (see videos of Yousefi et al. 2018). Data3.mat and Data4.mat are examples of fMRI single slice rat data under dexmedetomidine and isoflurane, respectively; visualization of single sliced can be done simply by using imagesc and pause functions in Matlab.


CompareQPPs calls TCMPwFPHM function to compare two group QPPs, e.g., from two age groups, using fine-phase-matching. Other than two QPPs, max forward or backward time-shift (mxlg) should be inputted, set to WL/4 at maximum. Note, size of QPP arrays for comparison should be identical, for instance, both 360×60, and if they are group QPPs, there is less need for rigorous phase-adjustment.


RegressQPP calls TRegM1 function to regress QPP and plots QPP original correlation timecourse and the sliding correlation timecourse between QPP and residual timeseries to verify the goodness of regression. Since QPP involves co-activation of the major networks, it contributes to the functional connectivity (FC), particularly within networks, hence FC difference can be compared before and after regression of QPP: again, visualizations are data-specific and an example is provided, based on FC between Glasser’s parcels re-ordered based on Yeo’s networks. Regression algorithm is done in the most simplistic form, by convolving C1 and T1 per parcel and using GLM. A more elaborated method which is based on segment-wise regression of QPP starting from the largest local maxima of its correlation, has been implemented (not shared in Nov18 version) and it shows similar trends in overall FC reduction.
